---
title: "R Notebook"

---
```{css, echo=FALSE}
 body {
  background-color: transparent;
   color: #FFFFFF;
}
```


# Vignette


```{r, eval=TRUE, warnings=FALSE, messages=FALSE, collapse = TRUE}

library(stplanr)
library(dplyr) 
library(leaflet)
library(gbfs)
library(sp)
library(maptools)
library(mapdeck)
library(leaflet.extras)
```

```{r, eval=FALSE}
possible_cities <- get_gbfs_cities()
possible_cities
```


```{r, eval=FALSE}

get_gbfs(city = "Montreal, QC", feeds = "all", directory = "BIKI_data")
```


```{r, eval=FALSE}
list.files("BIKI_data")
```


```{r}
station_status <- readRDS("data/BIKI_data/station_status.rds")
head(station_status)
```

```{r}
station_info <- readRDS("data/BIKI_data/station_information.rds")
head(station_info)
```

```{r}
system_info <- readRDS("data/BIKI_data/system_information.rds")
head(system_info)
```

```{r}
station_info <- read.csv("data/BIKI_data/Stations_2018.csv")
#read.csv("BIKI_data/OD_2018-04.csv")
#read.csv("BIKI_data/OD_2018-05.csv")
flow <- read.csv("data/BIKI_data/OD_2018-06.csv")[,c(2, 4, 1, 3, 5, 6)]
#read.csv("BIKI_data/OD_2018-07.csv")
#read.csv("BIKI_data/OD_2018-08.csv")
#read.csv("BIKI_data/OD_2018-09.csv")
#read.csv("BIKI_data/OD_2018-10.csv")
names(flow)
```


```{r}
station_points <- SpatialPointsDataFrame(coords =cbind(station_info$lon, station_info$lat), data = station_info)
plot(station_points, pch=19, cex=0.4)

```

time ... corpuscular .. track sunrise window  Solar()

```{r, eval=TRUE}
travel_network <- od2line(flow = flow[30000:31000,], zones = station_points)
w <- flow$is_member / max(flow$is_member) *1

```

```{r, echo=FALSE, fig.cap = "A line connecting the pickup and dropoff locations of each individual bike and each individual trip. \\label{desire_lines}"}
plot(travel_network, lwd = w)
```


```{r, eval=TRUE, echo=FALSE}
load("data/BIKI_data/rates_t_routes.Rdata")
```

```{r, eval=FALSE, warnings=FALSE}
intrazone <- travel_network$start_station_code == travel_network$end_station_code
travel_network <- travel_network[!intrazone,]
t_routes <- line2route(travel_network, route_fun = route_osrm ) 
#route_graphhopper
plot(t_routes)
t_routes$All <- travel_network$All

rates <- cbind(t_routes$id, t_routes$distance / t_routes$duration)
rownames(rates) <- t_routes$id
colnames(rates) <- c("id","rates")

rates_t_routes <- merge(t_routes, rates, by.x="id")
rates_t_routes@data$rates  <- as.numeric(rates_t_routes@data$rates )
rates_t_routes@data$rates[which(rates_t_routes@data$rates == 0)] <- NA

save(rates_t_routes, file="data/BIKI_data/rates_t_routes.Rdata")
plot(rates_t_routes)
```

```{r}
plot(rates_t_routes)
```

```{r, eval=FALSE}

rnet <- overline(rates_t_routes, attrib = "rates", fun = sum, na.zero =FALSE)
save(rnet, file="data/BIKI_data/rnet.Rdata")

```

```{r, echo=FALSE, fig.cap = "Average speed along each roadway. \\label{flow_network}"}
load("data/BIKI_data/rnet.Rdata")
plot(rnet, lwd=rnet@data$rates/6000)

```


BIXI average speed
```{r}
leaflet() %>% 
  addProviderTiles("CartoDB.DarkMatterNoLabels")%>% addPolylines(data = rnet, col="firebrick",  
  opacity=1, weight = rnet@data$rates/6000
  )  #%>% suspendScroll()
```






